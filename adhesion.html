<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adh√©sion √† l‚ÄôASA ‚Äî Association des S√©n√©galais d‚ÄôAmiens</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="bg-light container mt-5 mb-5 form-container p-4 shadow rounded">
    <h2 class="text-center mb-4">Adh√©rer √† l‚ÄôASA ‚Äî Formulaire d‚Äôinscription</h2>

    <!-- ‚úÖ Soumission native -->
    <form id="asaForm" action="https://script.google.com/macros/s/AKfycbx0w2NsM2oaPT_YWDVM0QHMJFgHHlaT7Qy5QdSvQy3NwJMo-FgRwm5P_UWkgclbNG73aA/exec" method="POST" enctype="multipart/form-data">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label" for="prenom">Pr√©nom¬∑s <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="prenom" name="prenom" required />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label" for="nom">Nom <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="nom" name="nom" required />
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label" for="telephone">T√©l√©phone (WhatsApp) <span class="text-danger">*</span></label>
          <input type="tel" class="form-control" id="telephone" name="telephone" placeholder="+33 6 12 34 56 78" maxlength="20" required />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label" for="email">Adresse e-mail</label>
          <input type="email" class="form-control" id="email" name="email" />
        </div>
      </div>

      <h4 class="mt-3">Justificatif de r√©sidence</h4>
      <div class="form-group mb-3">
        <label class="form-label" for="justificatif">T√©l√©verser le justificatif <span class="text-danger">*</span></label>
        <input type="file" class="form-control" id="justificatif" name="justificatif" accept=".pdf,.jpg,.jpeg,.png,.webp" required />
        <small class="text-muted">PDF, JPG, PNG, WEBP ‚Äî max 10 Mo.</small>
      </div>

      <div class="form-group mb-3">
        <label class="form-label" for="commentaires">Commentaires (facultatif)</label>
        <textarea class="form-control" id="commentaires" name="commentaires" rows="4"></textarea>
      </div>

      <div class="form-check mb-4">
        <input type="checkbox" class="form-check-input" id="consentement" name="consentement" value="Oui" required />
        <label class="form-check-label" for="consentement">Je consens au traitement de mes donn√©es. *</label>
      </div>

      <!-- üîí Champs cach√©s pour l‚Äôupload base64 (fallback fiable) -->
      <input type="hidden" id="justificatif_base64" name="justificatif_base64" />
      <input type="hidden" id="justificatif_name" name="justificatif_name" />
      <input type="hidden" id="justificatif_type" name="justificatif_type" />

      <div id="loadingMessage" style="display:none; text-align:center;">
        <p><strong>Envoi en cours‚Ä¶</strong></p>
      </div>

      <button type="submit" class="btn btn-primary w-100 mt-2 btn-submit">Envoyer ma demande d‚Äôadh√©sion</button>
    </form>
  </div>

  <script>
    const form = document.getElementById('asaForm');
    const fileInput = document.getElementById('justificatif');
    const base64Input = document.getElementById('justificatif_base64');
    const nameInput  = document.getElementById('justificatif_name');
    const typeInput  = document.getElementById('justificatif_type');
    const loadingMsg = document.getElementById('loadingMessage');
    const submitBtn  = document.querySelector('.btn-submit');

    // Pr√©nom: Capitaliser, Nom: Majuscules (optionnel)
    document.getElementById('prenom').addEventListener('input', function() {
      this.value = this.value
        .toLowerCase()
        .split(' ')
        .map(w => w.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('-'))
        .join(' ');
    });
    document.getElementById('nom').addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });

    // Taille max 10 Mo
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (f && f.size > 10 * 1024 * 1024) {
        alert('Fichier trop volumineux (max 10 Mo).');
        fileInput.value = '';
      }
    });

    // ‚öôÔ∏è Avant soumission: convertir le fichier en base64, peu importe si e.files sera vide c√¥t√© GAS
    form.addEventListener('submit', function(e) {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return; // le required emp√™che normalement

      e.preventDefault(); // on attend la lecture base64, puis on soumet

      submitBtn.disabled = true;
      loadingMsg.style.display = 'block';

      const reader = new FileReader();
      reader.onload = function(ev) {
        const dataUrl = ev.target.result; // "data:...;base64,AAAA"
        const base64 = dataUrl.split(',')[1]; // on garde uniquement la partie base64

        // Remplir les champs cach√©s
        base64Input.value = base64;
        nameInput.value   = file.name;
        typeInput.value   = file.type || 'application/octet-stream';

        // Option: d√©sactiver le champ fichier pour √©viter les bizarreries c√¥t√© GAS
        // (on efface juste son name pour ne pas doubler les donn√©es)
        fileInput.removeAttribute('name');

        // Soumettre vraiment (POST natif du navigateur vers Apps Script)
        form.submit();
      };
      reader.onerror = function() {
        submitBtn.disabled = false;
        loadingMsg.style.display = 'none';
        alert('Impossible de lire le fichier.');
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
